#include <Arduino.h>
#include "web/webserver.h"
#include <ETH.h>

static bool eth_connected = false;

void WiFiEvent(WiFiEvent_t event) {
    switch (event) {
        case ARDUINO_EVENT_ETH_START:
            Serial.println("ETH started");
            ETH.setHostname("esp32-eth");
            break;

        case ARDUINO_EVENT_ETH_CONNECTED:
            Serial.println("ETH connected");
            break;

        case ARDUINO_EVENT_ETH_GOT_IP:
            Serial.print("ETH IP: ");
            Serial.println(ETH.localIP());
            eth_connected = true;
            break;

        case ARDUINO_EVENT_ETH_DISCONNECTED:
            Serial.println("ETH disconnected");
            eth_connected = false;
            break;

        default:
            break;
    }
}

void setup() {
    Serial.begin(115200);
    delay(500);

    WiFi.onEvent(WiFiEvent);

    // â˜… Wichtig: Waveshare ESP32-S3-ETH Pinout
    ETH.begin(
        1,      // PHY addr (LAN8720 default = 1)
        38,     // Power pin
        23,     // MDC
        18,     // MDIO
        ETH_PHY_LAN8720,
        ETH_CLOCK_GPIO0_IN
    );

    // Warten bis Ethernet aktiv
    while (!eth_connected) {
        Serial.println("Waiting for Ethernet...");
        delay(500);
    }

    web_init();
}

void loop() {
    web_loop();
}
